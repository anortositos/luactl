#!/bin/sh -ea
#? Lua Environment Manager - v${version}
#?
#? Usage:
#?   ${program} <COMMAND> [OPTION]
#?
#? Commands:
#?   init        Initialize the Lua environment.
#?   download    Download the Lua source code.
#?   install     Install Lua version.
#?
#? Options:
#?   -h,--help   Show this message.
#?. 

luavm_pushpath() {
  : ${1:?path}
  echo "$1:$PATH" | awk -v RS=':' -v ORS=':' '!path[$1]++'
}

luavm_check() {
  test -n "$LUAVM_HOME" && test -d "$LUAVM_HOME" && test -f "$LUAVM_ENVRC"
}

luavm_config() {
  export LUAVM_HOME=$HOME/.luavm
  export LUAVM_ENVRC=$LUAVM_HOME/envrc
}

luavm_init() {
  : ${1:?version}
  export LUA_VERSION=$1
  export LUA_HOME=$LUAVM_HOME/luas
  export LUA_SOURCE=$LUAVM_HOME/src
  export LUA_PATH=";;$LUA_HOME/share/lua/$LUA_VERSION/?.lua;$LUA_HOME/share/lua/$LUA_VERSION/?/init.lua"
  export LUA_CPATH=";;$LUA_HOME/lib/lua/$LUA_VERSION/?.so"
  export LUA_INIT='require "luarocks.loader"'
  export PATH="$(luavm_pushpath $LUA_HOME/bin)"
  echo "Creating $LUA_HOME ..."
    mkdir -p $LUA_HOME
  echo "Creating $LUA_SOURCE ..."
    mkdir -p $LUA_SOURCE
  echo "Creating configurarion file $LUAVM_ENVRC ..."
    echo "LUAVM_HOME=\"$LUAVM_HOME\""   >  "$LUAVM_ENVRC"
    echo "LUAVM_ENVRC=\"$LUAVM_ENVRC\"" >> "$LUAVM_ENVRC"
    echo "LUA_VERSION=\"$LUA_VERSION\"" >> "$LUAVM_ENVRC"
    echo "LUA_HOME=\"$LUA_HOME\""       >> "$LUAVM_ENVRC"
    echo "LUA_SOURCE=\"$LUA_SOURCE\""   >> "$LUAVM_ENVRC"
    echo "LUA_PATH=\"$LUA_PATH\""       >> "$LUAVM_ENVRC"
    echo "LUA_CPATH=\"$LUA_CPATH\""     >> "$LUAVM_ENVRC"
    echo "LUA_INIT=\"$LUA_INIT\""       >> "$LUAVM_ENVRC"
    echo "PATH=\"$PATH\""               >> "$LUAVM_ENVRC"
}

luavm_patch() {
  : ${1:?source directory}
  : ${2:?target directory}

  cp $1/src/luaconf.h $1/src/luaconf.h.orig
  sed "s|^\(#define LUA_ROOT\)\(.*\)$|\1 \"$2\"|" $1/src/luaconf.h.orig > $1/src/luaconf.h

  cp $1/Makefile $1/Makefile.orig
  sed "s|^\(INSTALL_TOP= \)\(.*\)$|\1$2|" $1/Makefile.orig > $1/Makefile
}

command_help() {
  local program=${0##*/}
  local version=0.1.0
  eval "echo \"$(grep '^#[?]' "${0}" | cut -c4-)\""
}

command_download() {
  : ${1:?version}
  local version=$1
  local wget=$(command -v wget)
  local url=http://www.lua.org/ftp
  local src=lua-$version.tar.gz

  luavm_check || {
    luavm_config
    luavm_init $1
  }

  test -x $wget && {
    cd $LUA_SOURCE
    $wget --continue --progress=dot --tries 3 $url/$src
    cd - > /dev/null
  }
}

command_install() {
  : ${1:?version}
  local lua=lua-$1
  local tar=$(command -v tar)

  luavm_check || {
    luavm_config
    luavm_init $1
  }

  test -f $LUA_SOURCE/$lua.tar.gz || command_download $1

  cd $LUA_SOURCE && {
    $tar -xf $LUA_SOURCE/$lua.tar.gz --overwrite --directory=$LUA_SOURCE
    luavm_patch $LUA_SOURCE/$lua $LUA_HOME/$lua
    cd $LUA_SOURCE/$lua && {
      make clean linux
      make install
    }
  }
}

trap '{ command_help; exit $?; }' 1 2

command=$(command -v command_$1 || echo command_help)

test $# -gt 0 && shift 1

$command "${@}"

exit $?

